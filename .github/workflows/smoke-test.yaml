name: Smoke Integration Tests

on:
  workflow_dispatch:

jobs:
  integration-tests:
    name: Run Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      # --- Install kubectl ---
      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      # --- Install Minikube ---
      - name: Install Minikube
        run: |
          curl -Lo minikube https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
          chmod +x minikube
          sudo mv minikube /usr/local/bin/

      # --- Install Helm ---
      - name: Install Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      # --- Start Minikube ---
      - name: Start Minikube
        run: |
          minikube start --driver=docker --cpus=2 --memory=4096
          minikube status

      # --- Optional: Enable ingress addon ---
      - name: Enable Ingress
        run: minikube addons enable ingress

      # --- Optional: Verify cluster and Helm ---
      - name: Verify cluster and Helm
        run: |
          kubectl get nodes
          helm version

      # --- Deploy Rimfrost ---
      - name: Deploy Rimfrost
        run: ./deploy.sh minikube

      # --- Run integration tests ---
      - name: Run Maven verify
        run: mvn verify

      # --- Optional: Dump logs on failure ---
      - name: Dump Kubernetes logs
        if: failure()
        run: |
          kubectl get all -A
          kubectl describe pods -A
          kubectl logs -A --tail=100